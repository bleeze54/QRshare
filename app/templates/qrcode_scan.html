{% extends "header.html" %}

{% block title %}Scan ton qrcode{% endblock %}

{% block content %}
<head>
  <meta charset="UTF-8">
  <title>QR Share</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

</head>
<body>
<h1>Scanner et Partager</h1>
<input type="text" id="pseudo" placeholder="Votre pseudo (optionnel)">
<video id="video" autoplay playsinline></video>
<canvas id="canvas" hidden></canvas>
<div id="result"></div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
const ws = new WebSocket("wss://https://qrshare.estebanfourage.fr/ws/qr/"); // IP ou nom de domaine utilis√©
ws.onopen = () => console.log("‚úÖ WebSocket connect√©");
ws.onmessage = (event) => console.log("üì© R√©ponse serveur:", event.data);

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const resultDiv = document.getElementById("result");

let stream; // garder une r√©f√©rence au flux vid√©o

navigator.mediaDevices.getUserMedia({
    video: {
        facingMode: "environment",
        width: { ideal: 1280 },
        height: { ideal: 720 }
    }
})
.then((s) => {
    stream = s;
    video.srcObject = stream;
    video.setAttribute("playsinline", true);
    video.play();
    scanLoop();
})
.catch((err) => console.error("Erreur cam√©ra:", err));

// üîç Fonction de scan
function scanLoop() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
            resultDiv.innerText = "QR trouv√©: " + code.data;
            const pseudo = document.getElementById("pseudo").value || "user123";

            // Envoi au serveur
            ws.send(JSON.stringify({ pseudo: pseudo, qr_code: code.data }));
        }
    }
    requestAnimationFrame(scanLoop);
}

// üì∏ Quand on clique sur la vid√©o, on tente de relancer l‚Äôautofocus
video.addEventListener("click", () => {
    if (!stream) return;
    const track = stream.getVideoTracks()[0];
    if (track) {
        track.applyConstraints({
            advanced: [{ focusMode: "continuous" }]
        }).then(() => {
            console.log("üîÑ Autofocus relanc√©");
        }).catch(err => {
            console.warn("‚ö†Ô∏è Contrainte non support√©e:", err);
        });
    }
});
</script>

{% endblock %}
